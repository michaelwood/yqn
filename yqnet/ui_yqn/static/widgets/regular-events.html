
<script type="text/x-template" id="regular-events-template">
    <div id="events-widget">
       <div class="border-gray p-1 mb-0">
        Alphabetical:
            <a href='#' class="badge badge-light"
            v-for="letter in alphabet"
            v-on:click.prevent="search = letter; searchText = '' ">{{letter}}</a>
        </div>

        <div class="form-group">
            <input type="text" v-model="searchText" class="form-control" placeholder="Search..." />
        </div>

       <p v-if="regularEvents.length == 0 && enabled">None!</p>

       <transition-group name="list" tag="div">
           <div class="d-flex flex-row w-100 p-1 shadow-sm bg-white rounded pt-3 mb-3 list-item" v-for="event in regularEvents" v-bind:key="event.id" >
               <div class="d-flex flex-column flex-fill">
                    <div class="d-flex flex-row">

                        <div class="rounded-circle post-thumb d-block" style="min-width: 90px; background-color: #343a40">
                            <h3 class="text-center mt-4" style="color: white;"><i class="far fa-calendar-alt"></i></h3>
                        </div>

                        <div class="d-flex flex-row flex-fill">
                            <div class="ml-3 d-flex flex-column pb-2 flex-fill">
                                <h3>{{event.title}}</h3>
                                <p>
                                <span v-if="event.group_page_details">Group: <a v-bind:href="event.group_page_details.url">{{event.group_page_details.title}}</a><br /></span>
                                Location: {{event.venue_details.title}} <span v-html="event.venue_details.address"></span> <a v-bind:href="'https://www.google.com/maps/search/?api=1&query=' + encodeURI(event.venue_details.lat)+',' +encodeURI(event.venue_details.lng) ">Map</a>
                                </p>
                            </div>
                        </div>

                    </div>
                    <a class="mt-2 mb-2" v-if="event.url" v-bind:href="event.url">Find out more - {{event.title}}</a>
                    <a class="mt-2 mb-2 ml-auto" v-if="event.has_email" href="#" v-on:click.prevent='yqnBus.$emit("contact", { modelName: "EventsLocation", objectId: event.id, title: event.title } )'>Contact organiser</a>
                </div>

                <div class="dropdown dropleft action-menu-yqn">
                    <a href class="action-menu-yqn p-1 dropdown-toggle" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" href="#" v-on:click.prevent="yqnUtils.share(event.url)">Share</a>
                        <a v-if="event.user.id == yqnUtils.loggedInUser.id" class="dropdown-item" href="#" v-on:click.prevent="deleteObj(event.id)">Delete</a>
                        <a class="dropdown-item" href="#" v-on:click.prevent="yqnBus.$emit('contact', { modelName: 'EventsLocation', objectId: event.id, title: 'Report: '+event.title, report: true })">Report <i class="far fa-flag"></i></a>
                    </div>
                </div> <!-- / dropdown -->
           </div>
       </transition-group>
   </div> <!-- end events widget -->
   </script>


   <script type="text/javascript">

       Vue.component('regular-events', {
           props: {

            },

           template: '#regular-events-template',

           data: function() {
               return {
                   alphabet: ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'],
                   search: 'a',
                   searchText: '',
                   yqnUtils: yqnUtils,
                   yqnBus: yqnBus,
                   regularEvents: [],
                   enabled: false,
                   searchTimer: null,
               }
           },

           watch: {
               search: "fetchData",
               searchText: "waitForTypingToStop",
           },

           created: function (){
                let ctx = this;

                this.fetchData();

                yqnBus.$on("data-added", function(){
                    /* TODO instead of refresh we could appened to the events[] ? */
                    console.log("Get message data changed");
                    ctx.fetchData();
                });
           },

           updated: function(){
               /* Setup the Bootstrap tooltips */
               this.$nextTick(function () {
                   $(".list-item [title]").tooltip();
               });
           },


           methods: {
               fetchData() {
                   let ctx = this;

                   let url = "/api/EventsLocations/"

                   if (this.search){
                       url += yqnUtils.urlParams({ search: "^"+this.search.replace(" ", "+") });
                   }


                   $.getJSON(url, function (data) {
                       ctx.regularEvents = data;
                       ctx.enabled = true;
                       ctx.nextPageUrl = data.next;
                   });
               },

               deleteObj(id){
                   let ctx = this;
                   yqnUtils.delete("/api/EventsLocation/" + id, function(){
                       yqnBus.$emit("notify", { title: "Deleted", body: "Event deleted"});
                       ctx.fetchData();
                   });
               },

               waitForTypingToStop(){
                   if (this.searchTimer){
                       window.clearTimeout(this.searchTimer);
                   }

                   let ctx = this;
                   this.searchTimer = window.setTimeout(function(){
                       ctx.search = ctx.searchText;
                   }, 500);

               },
           }
       });

   var vApp = new Vue({
       el: '#regular-events-app',
   });

   </script>
